<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <title>Chat con Socket.IO</title>
    <link rel="stylesheet" href="styleChat.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script type="module" src="https://cdn.jsdelivr.net/npm/emoji-picker-element@^1/index.js"></script>
</head>

<body>
    <div class="logo-container">
        <img src="imagen2.png" alt="LieCake Logo">
    </div>
    <a href="#" class="back-button" onclick="regresar(event)">
        <i class="fas fa-arrow-left"></i>
        <!-- Icono de flecha hacia atrÃ¡s -->
        <span>Volver</span>
    </a>
    <div class="chat-container">
        <div class="chat-header">LieCake Chat</div>
        <div class="chat-box" id="chatBox">
            <ul id="mensajes"></ul>
            <div id="escribiendo" class="typing-indicator" style="color: gray; font-style: italic; margin: 5px 0;">
            </div>
        </div>
        <div class="display:flex; flex-direction:column;">
            <div class="chat-input">
                <input type="text" id="mensaje" placeholder="Escribe un mensaje..." autocomplete="off">
                <button id="btnEmoji">ðŸ˜€</button>
                <button id="btnEnviar">Enviar</button>
            </div>
        </div>
        <div class="archivo">
            <label for="archivoFile" class="botonArchivo">
                Seleccionar Archivo
            </label>
            <input id="archivoFile" type="file">
            <span id="nombre-archivo">NingÃºn archivo seleccionado</span>
        </div>
        <div>
            <emoji-picker id="emojiPicker"
                style="display:none; position: absolute; bottom: 120px; right: 30px;"></emoji-picker>
        </div>
    </div>


    <!-- script para mostrar el nombre del archivo -->

    <script>
        const input = document.getElementById('archivoFile');
        const nombreArchivo = document.getElementById('nombre-archivo');

        input.addEventListener('change', () => {
            if (input.files.length > 0) {
                nombreArchivo.textContent = "Archivo: " + input.files[0].name;
            } else {
                nombreArchivo.textContent = "NingÃºn archivo seleccionado";
            }
        });
    </script>

    <!-- IMPORTA SOCKET.IO DESPUÃ‰S DEL BODY -->
    <script src="/socket.io/socket.io.js"></script>

    <script>
        function regresar(event) {
            event.preventDefault(); // Evita el comportamiento por defecto del enlace
            localStorage.removeItem("nombre"); // Limpia el nombre del localStorage
            localStorage.removeItem("avatar"); // Limpia el avatar del localStorage
            window.location.href = "usuario.html"; // Redirige a usuario.html
        }

        //Todo desde la vista
        const params = new URLSearchParams(window.location.search);
        const nombre = params.get("input_nombre")
        const socket = io();

        // Registrarse al servidor-agregado ultimo
        socket.emit("registrar usuario", nombre);

        //Recibir la informaciÃ³n del archivo a subir al chat
        socket.on('archivo', function (data) {

            if (data) {
                let li = document.createElement('li');
                console.log("Extension es: ", data.extension);
                if (data.extension === "image") {
                    li = document.createElement('li');
                    const img = document.createElement('img');
                    img.src = data.url;
                    img.alt = "Imagen";
                    img.style.maxWidth = '200px';
                    li.appendChild(img);
                }
                else if (data.extension === "video") {
                    li = document.createElement('li');
                    const video = document.createElement('video');
                    video.src = data.url;
                    video.controls = true;
                    video.style.maxWidth = '300px';
                    li.appendChild(video);
                }
                else if (data.extension === "raw") {
                    li = document.createElement('li');
                    const a = document.createElement('a');
                    a.href = data.url;
                    a.textContent = "Descargar documento";

                    li.appendChild(a);
                }

                //Mostrar en el chat
                document.getElementById("mensajes").appendChild(li);
            }
        });

        // Mostrar mensajes entrantes
        socket.on('chat message', function (msg) {
            // msg es un string JSON, conviÃ©rtelo a objeto
            let data;
            try {
                data = JSON.parse(msg);
            } catch {
                // Compatibilidad con mensajes antiguos
                const partes = msg.split(':');
                data = {
                    nombre: partes[0],
                    mensaje: partes.slice(1).join(':').trim(),
                    avatar: ""
                };
            }

            const item = document.createElement('li');
            const div = document.createElement('div');
            const container_message = document.createElement('div');
            //const span = document.createElement('span');
            const mensajeContenido = document.createElement('div');
            const horaElemento = document.createElement('div');

            const avatarLocal = localStorage.getItem("avatar");

            const avatarImg = document.createElement('img');
            avatarImg.src = avatarLocal || "https://ui-avatars.com/api/?name=" + encodeURIComponent(data.nombre);
            avatarImg.alt = "avatar";
            avatarImg.style.width = "32px";
            avatarImg.style.height = "32px";
            avatarImg.style.borderRadius = "50%";
            avatarImg.style.objectFit = "cover";

            if (data.nombre === nombre) {
                div.className = 'user';
                container_message.className = 'container-message';
                container_message.appendChild(avatarImg);
                container_message.appendChild(mensajeContenido);
                div.appendChild(container_message);
                mensajeContenido.className = 'mensaje-contenido';
                mensajeContenido.textContent = "Tu: " + data.mensaje;
                horaElemento.className = 'mensaje-hora';
                horaElemento.textContent = data.hora || "??:??";
                div.appendChild(horaElemento);

            } else {
                div.className = 'other';
                div.appendChild(avatarImg);
                mensajeContenido.className = 'mensaje-contenido';
                mensajeContenido.textContent = data.nombre + ": " + data.mensaje;
                horaElemento.className = 'mensaje-hora';
                horaElemento.textContent = data.hora || "??:??";
                div.appendChild(mensajeContenido);
                div.appendChild(horaElemento);

            }
            document.getElementById('mensajes').appendChild(item).appendChild(div);
        });

        async function enviar() {
            let archivo_file = document.getElementById("archivoFile").files[0];
            console.log("El archivo_file es: ", archivo_file);
            if (archivo_file) {
                const reader = new FileReader();
                reader.onload = async function (e) {
                    try {
                        const contenido = e.target.result.trim();

                        if (contenido.length === 0) {
                            return alert("No se puede enviar archivos vacÃ­os");
                        }

                        //El contenido si o si debe de tener contenido antes de empezar
                        if (contenido.length !== 0) {

                            const formData = new FormData();
                            formData.append("archivo", archivo_file);
                            const response = await fetch("/api/upload-file", {
                                method: 'POST',
                                body: formData,
                            });
                            console.log("Status:", response.status);

                            if (!response.ok) {
                                const errorText = await response.text();
                                throw new Error(
                                    `Error en la subida: ${response.status} - ${errorText}`
                                );
                            }

                            const resultado = await response.json();
                            const urlCloudinary = resultado.url;
                            console.log(urlCloudinary);

                            socket.emit("archivo", {
                                url: urlCloudinary,
                                extension: resultado.extension,
                                nombre: archivo_file.name
                            });
                        }
                    } catch (error) {
                        console.error("Error al subir el archivo:", error);
                        alert(
                            "Hubo un error al subir el archivo. IntÃ©ntalo de nuevo. Detalle: " +
                            error.message
                        );
                        return;
                    }
                }
                reader.readAsText(archivo_file);
                document.getElementById("archivoFile").value = "";
            }

            const input = document.getElementById('mensaje');
            const mensaje = input.value.trim();
            const avatar = localStorage.getItem("avatar") || ""; // Usa tu avatar o vacÃ­o
            if (mensaje !== '') {
                // Agrega la hora al mensaje
                const hora = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                // Envia un objeto con nombre, mensaje y avatar
                socket.emit('chat message', JSON.stringify({
                    nombre: nombre,
                    mensaje: mensaje,
                    avatar: avatar,
                    hora: hora
                }));
                input.value = '';
            }
        }

        document.getElementById('btnEnviar').addEventListener('click', enviar);
        // EnvÃ­o con tecla Enter
        document.getElementById('mensaje').addEventListener('keypress', function (event) {
            if (event.key === 'Enter') {
                event.preventDefault(); // Evita saltos de lÃ­nea
                enviar(); // Llama a la funciÃ³n de envÃ­o
            }
            document.getElementById('mensaje').addEventListener('input', () => {
                socket.emit('escribiendo', nombre);
            });
        });


        // Mostrar notificaciÃ³n de conexiÃ³n/desconexiÃ³n
        function mostrarNotificacion(texto) {
            const chatBox = document.getElementById('mensajes');
            const li = document.createElement('li');
            li.className = 'notificacion';
            li.textContent = texto;
            chatBox.appendChild(li);
            document.getElementById('chatBox').scrollTop = document.getElementById('chatBox').scrollHeight;
        }

        socket.on('usuario conectado', function (texto) {
            mostrarNotificacion(texto);
        });

        socket.on('usuario desconectado', function (texto) {
            mostrarNotificacion(texto);
        });

        socket.on('mostrar escribiendo', function (nombreRemoto) {
            if (nombreRemoto !== nombre) {
                const escribirDiv = document.getElementById('escribiendo');
                escribirDiv.textContent = `${nombreRemoto} estÃ¡ escribiendo...`;

                clearTimeout(window.escribiendoTimeout);
                window.escribiendoTimeout = setTimeout(() => {
                    escribirDiv.textContent = '';
                }, 2000);
            }
        });
        const btnEmoji = document.getElementById('btnEmoji');
        const emojiPicker = document.getElementById('emojiPicker');
        const inputMensaje = document.getElementById('mensaje');

        // Alternar el panel de emojis
        btnEmoji.addEventListener('click', () => {
            emojiPicker.style.display = emojiPicker.style.display === 'none' ? 'block' : 'none';
        });

        // Insertar emoji al input
        emojiPicker.addEventListener('emoji-click', (event) => {
            const emoji = event.detail.unicode;
            inputMensaje.value += emoji;
            inputMensaje.focus();
        });

    </script>


</body>

</html>